<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperLocal - æ¬¡ä¸–ä»£ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #EBF4FF 0%, #F3E8FF 50%, #FCE7F3 100%);
            min-height: 100vh;
        }

        .app-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 100vh;
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            .map-panel {
                display: none;
            }
        }

        .sidebar {
            background: white;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .map-panel {
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .header {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .location {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .content {
            padding: 1rem;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #6b7280;
            position: relative;
            transition: all 0.3s;
        }

        .tab.active {
            color: #a855f7;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #3b82f6, #a855f7);
        }

        .icon-circle {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-green {
            background: linear-gradient(135deg, #10b981, #3b82f6);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #a855f7;
        }

        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .voice-input {
            background: #EFF6FF;
            border: 2px dashed #BFDBFE;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-input:hover {
            background: #DBEAFE;
            border-color: #3b82f6;
        }

        .voice-input.active {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            color: white;
            border-style: solid;
        }

        .task-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-card:hover {
            border-color: #a855f7;
            background: #faf5ff;
            transform: translateY(-2px);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .task-title {
            font-weight: 600;
            color: #1f2937;
        }

        .task-reward {
            background: linear-gradient(135deg, #10b981, #3b82f6);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .task-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0.25rem 0;
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-card:hover {
            border-color: #a855f7;
            background: #faf5ff;
        }

        .user-avatar {
            width: 3rem;
            height: 3rem;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #1f2937;
        }

        .user-meta {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .user-select {
            color: #a855f7;
            font-weight: 600;
        }

        .summary {
            background: #f9fafb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            font-size: 0.875rem;
        }

        .summary-total {
            border-top: 2px solid #e5e7eb;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            font-weight: bold;
            font-size: 1rem;
        }

        .tech-stack {
            background: #ECFDF5;
            border-radius: 0.75rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .tech-stack-title {
            color: #065F46;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .tech-stack ul {
            list-style: none;
        }

        .tech-stack li {
            color: #047857;
            font-size: 0.875rem;
            margin: 0.25rem 0;
            padding-left: 1rem;
            position: relative;
        }

        .tech-stack li::before {
            content: 'â€¢';
            position: absolute;
            left: 0;
        }

        .post-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .post-card {
            background: #f9fafb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .post-category {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .post-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .post-content {
            color: #374151;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .center {
            text-align: center;
        }

        .maplibregl-popup-content {
            padding: 1rem;
            border-radius: 0.75rem;
        }

        .maplibregl-popup-content h3 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
        }

        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .map-control-btn {
            background: white;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .map-control-btn:hover {
            background: #f3f4f6;
            transform: translateX(-2px);
        }

        .map-control-btn.active {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            color: white;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="header">
                <div class="header-top">
                    <div class="title">ğŸŒŸ HyperLocal</div>
                    <div class="location" id="headerLocation">ğŸ“ ä½ç½®æƒ…å ±å–å¾—ä¸­...</div>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="activeTasks">0</div>
                        <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¹ã‚¯</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="nearbyHelpers">0</div>
                        <div class="stat-label">è¿‘ãã®ãƒ˜ãƒ«ãƒ‘ãƒ¼</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalReward">0</div>
                        <div class="stat-label">å ±é…¬ç·é¡(JPYC)</div>
                    </div>
                </div>
            </div>

            <div class="content" id="mainContent">
                <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯JSã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <div class="map-panel">
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-control-btn active" id="showTasks">ğŸ“‹ ã‚¿ã‚¹ã‚¯è¡¨ç¤º</button>
                <button class="map-control-btn" id="showHelpers">ğŸ‘¥ ãƒ˜ãƒ«ãƒ‘ãƒ¼è¡¨ç¤º</button>
                <button class="map-control-btn" id="showPosts">ğŸ“± æŠ•ç¨¿è¡¨ç¤º</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†
        const app = {
            map: null,
            currentLocation: null,
            currentStep: 'home',
            currentTab: 'request',
            tasks: [],
            helpers: [],
            posts: [],
            selectedTask: null,
            selectedHelper: null,
            voiceInput: '',
            mapMode: 'tasks'
        };

        // MapLibreåœ°å›³ã‚¹ã‚¿ã‚¤ãƒ«
        const mapStyle = {
            version: 8,
            sources: {
                osm: {
                    type: 'raster',
                    tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: 'Â© OpenStreetMap contributors'
                }
            },
            layers: [{
                id: 'osm',
                type: 'raster',
                source: 'osm'
            }]
        };

        // åœ°å›³åˆæœŸåŒ–
        function initMap(lat, lng) {
            if (app.map) {
                app.map.remove();
            }

            app.map = new maplibregl.Map({
                container: 'map',
                style: mapStyle,
                center: [lng, lat],
                zoom: 15
            });

            app.map.addControl(new maplibregl.NavigationControl());

            app.map.on('load', () => {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ãƒãƒ¼ã‚«ãƒ¼
                const el = document.createElement('div');
                el.style.width = '30px';
                el.style.height = '30px';
                el.style.backgroundImage = 'radial-gradient(circle, #3b82f6 40%, rgba(59, 130, 246, 0.3) 100%)';
                el.style.borderRadius = '50%';
                el.style.border = '3px solid white';
                el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';

                new maplibregl.Marker({element: el})
                    .setLngLat([lng, lat])
                    .setPopup(new maplibregl.Popup().setHTML('<h3>ã‚ãªãŸã®ç¾åœ¨åœ°</h3>'))
                    .addTo(app.map);

                updateMapMarkers();
            });
        }

        // åœ°å›³ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
        function updateMapMarkers() {
            if (!app.map || !app.map.loaded()) return;

            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ä»¥å¤–ï¼‰
            document.querySelectorAll('.custom-marker').forEach(el => el.remove());

            if (app.mapMode === 'tasks') {
                app.tasks.forEach(task => {
                    const el = document.createElement('div');
                    el.className = 'custom-marker';
                    el.style.width = '40px';
                    el.style.height = '40px';
                    el.style.background = 'linear-gradient(135deg, #10b981, #3b82f6)';
                    el.style.borderRadius = '50%';
                    el.style.border = '3px solid white';
                    el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                    el.style.display = 'flex';
                    el.style.alignItems = 'center';
                    el.style.justifyContent = 'center';
                    el.style.fontSize = '1.2rem';
                    el.textContent = 'ğŸ’¼';

                    new maplibregl.Marker({element: el})
                        .setLngLat([task.lng, task.lat])
                        .setPopup(new maplibregl.Popup().setHTML(`
                            <h3>${task.title}</h3>
                            <p>${task.location}</p>
                            <p><strong>${task.reward} JPYC</strong></p>
                        `))
                        .addTo(app.map);
                });
            } else if (app.mapMode === 'helpers') {
                app.helpers.forEach(helper => {
                    const el = document.createElement('div');
                    el.className = 'custom-marker';
                    el.style.width = '35px';
                    el.style.height = '35px';
                    el.style.background = 'linear-gradient(135deg, #60a5fa, #a78bfa)';
                    el.style.borderRadius = '50%';
                    el.style.border = '3px solid white';
                    el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                    el.style.display = 'flex';
                    el.style.alignItems = 'center';
                    el.style.justifyContent = 'center';
                    el.style.fontSize = '1rem';
                    el.textContent = 'ğŸ‘¤';

                    new maplibregl.Marker({element: el})
                        .setLngLat([helper.lng, helper.lat])
                        .setPopup(new maplibregl.Popup().setHTML(`
                            <h3>${helper.name}</h3>
                            <p>â­ ${helper.rating} | ğŸ“ ${helper.distance}m</p>
                        `))
                        .addTo(app.map);
                });
            } else if (app.mapMode === 'posts') {
                app.posts.forEach(post => {
                    const el = document.createElement('div');
                    el.className = 'custom-marker';
                    el.style.width = '25px';
                    el.style.height = '25px';
                    el.style.background = '#a855f7';
                    el.style.borderRadius = '50%';
                    el.style.border = '2px solid white';
                    el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';

                    new maplibregl.Marker({element: el})
                        .setLngLat([post.lng, post.lat])
                        .setPopup(new maplibregl.Popup().setHTML(`
                            <h3>${post.category}</h3>
                            <p>${post.content}</p>
                        `))
                        .addTo(app.map);
                });
            }
        }

        // è·é›¢è¨ˆç®—
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // ãƒ¡ãƒ¼ãƒˆãƒ«
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateSampleData() {
            if (!app.currentLocation) return;

            const { lat, lng } = app.currentLocation;

            // ã‚¿ã‚¹ã‚¯ç”Ÿæˆ
            app.tasks = [
                {
                    id: 1,
                    title: 'ã‚³ãƒ³ãƒ“ãƒ‹ã§è²·ã„ç‰©ä»£è¡Œ',
                    location: 'ãƒ­ãƒ¼ã‚½ãƒ³ æ¸‹è°·3ä¸ç›®åº—',
                    reward: 300,
                    duration: 15,
                    lat: lat + 0.002,
                    lng: lng + 0.002,
                    category: 'è²·ã„ç‰©'
                },
                {
                    id: 2,
                    title: 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé…é€',
                    location: 'æ¸‹è°·é§…å—å£',
                    reward: 500,
                    duration: 20,
                    lat: lat - 0.001,
                    lng: lng + 0.001,
                    category: 'é…é€'
                },
                {
                    id: 3,
                    title: 'ãƒšãƒƒãƒˆã®æ•£æ­©',
                    location: 'ä»£ã€…æœ¨å…¬åœ’',
                    reward: 800,
                    duration: 30,
                    lat: lat + 0.003,
                    lng: lng - 0.002,
                    category: 'ãƒšãƒƒãƒˆ'
                }
            ];

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼ç”Ÿæˆ
            app.helpers = [
                {
                    id: 1,
                    name: 'Taro Y.',
                    rating: 4.8,
                    response: '2åˆ†',
                    lat: lat + 0.0015,
                    lng: lng + 0.0015
                },
                {
                    id: 2,
                    name: 'Hanako S.',
                    rating: 4.9,
                    response: '3åˆ†',
                    lat: lat - 0.0008,
                    lng: lng + 0.0012
                },
                {
                    id: 3,
                    name: 'Ken T.',
                    rating: 4.7,
                    response: '5åˆ†',
                    lat: lat + 0.002,
                    lng: lng - 0.001
                }
            ];

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼ã«è·é›¢ã‚’è¿½åŠ 
            app.helpers.forEach(helper => {
                helper.distance = Math.round(calculateDistance(lat, lng, helper.lat, helper.lng));
            });

            // æŠ•ç¨¿ç”Ÿæˆ
            app.posts = [
                {
                    id: 1,
                    author: 'å±±ç”°å¤ªéƒ',
                    category: 'ã‚¤ãƒ™ãƒ³ãƒˆ',
                    content: 'æ˜æ—¥ã®åˆå¾Œ2æ™‚ã‹ã‚‰å…¬åœ’ã§ãƒ•ãƒªãƒé–‹å‚¬ï¼',
                    lat: lat + 0.0025,
                    lng: lng + 0.0025,
                    timestamp: Date.now() - 1800000
                },
                {
                    id: 2,
                    author: 'ä½è—¤èŠ±å­',
                    category: 'ãŠåº—',
                    content: 'é§…å‰ã®ã‚«ãƒ•ã‚§ãŒãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³',
                    lat: lat - 0.0015,
                    lng: lng + 0.0015,
                    timestamp: Date.now() - 3600000
                }
            ];

            updateStats();
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            document.getElementById('activeTasks').textContent = app.tasks.length;
            document.getElementById('nearbyHelpers').textContent = app.helpers.length;
            const totalReward = app.tasks.reduce((sum, task) => sum + task.reward, 0);
            document.getElementById('totalReward').textContent = totalReward;
        }

        // UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function render() {
            const content = document.getElementById('mainContent');

            if (app.currentStep === 'home') {
                content.innerHTML = `
                    <div class="tabs">
                        <button class="tab ${app.currentTab === 'request' ? 'active' : ''}" onclick="switchTab('request')">
                            ğŸ¤ ã‚¿ã‚¹ã‚¯ä¾é ¼
                        </button>
                        <button class="tab ${app.currentTab === 'browse' ? 'active' : ''}" onclick="switchTab('browse')">
                            ğŸ’¼ ã‚¿ã‚¹ã‚¯ä¸€è¦§
                        </button>
                        <button class="tab ${app.currentTab === 'community' ? 'active' : ''}" onclick="switchTab('community')">
                            ğŸ“± ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£
                        </button>
                    </div>

                    <div id="tabContent"></div>
                `;
                renderTab();
            } else if (app.currentStep === 'matching') {
                renderMatching();
            } else if (app.currentStep === 'payment') {
                renderPayment();
            } else if (app.currentStep === 'complete') {
                renderComplete();
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            app.currentTab = tab;
            render();
        }

        // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderTab() {
            const tabContent = document.getElementById('tabContent');

            if (app.currentTab === 'request') {
                tabContent.innerHTML = `
                    <div class="card">
                        <div class="center">
                            <div class="icon-circle">ğŸ¤</div>
                            <h2>ä½•ã‚’ãŠé¡˜ã„ã—ã¾ã™ã‹ï¼Ÿ</h2>
                            <p style="color: #6b7280; margin-bottom: 1rem;">éŸ³å£°ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã§ç°¡å˜ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</p>
                        </div>

                        <div class="voice-input" id="voiceInput" onclick="handleVoiceInput()">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ¤</div>
                            <div style="font-weight: 600;">éŸ³å£°ã§ä¾é ¼ã™ã‚‹</div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                                ã‚¿ãƒƒãƒ—ã—ã¦è©±ã—ã¦ãã ã•ã„
                            </div>
                        </div>

                        <div style="text-align: center; margin: 1rem 0; color: #9ca3af; font-size: 0.875rem;">
                            ã¾ãŸã¯
                        </div>

                        <div class="input-group">
                            <label>ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="taskTitle" placeholder="ä¾‹: ã‚³ãƒ³ãƒ“ãƒ‹ã§è²·ã„ç‰©">
                        </div>

                        <div class="input-group">
                            <label>å ´æ‰€</label>
                            <input type="text" id="taskLocation" placeholder="ä¾‹: ãƒ­ãƒ¼ã‚½ãƒ³ æ¸‹è°·3ä¸ç›®åº—">
                        </div>

                        <div class="input-group">
                            <label>è©³ç´°</label>
                            <textarea id="taskDetails" placeholder="å…·ä½“çš„ãªå†…å®¹ã‚’å…¥åŠ›..."></textarea>
                        </div>

                        <div class="input-group">
                            <label>å ±é…¬ (JPYC)</label>
                            <input type="number" id="taskReward" placeholder="ä¾‹: 300" min="1">
                        </div>

                        <button class="btn" onclick="createTask()">ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ</button>
                    </div>
            `;
        } else if (app.currentTab === 'browse') {
            tabContent.innerHTML = `
                <div class="card">
                    <div class="card-title">è¿‘ãã®ã‚¿ã‚¹ã‚¯ (500mä»¥å†…)</div>
                    ${app.tasks.map(task => `
                        <div class="task-card" onclick="selectTask(${task.id})">
                            <div class="task-header">
                                <div class="task-title">${task.title}</div>
                                <div class="task-reward">${task.reward} JPYC</div>
                            </div>
                            <div class="task-details">ğŸ“ ${task.location}</div>
                            <div class="task-details">â±ï¸ ${task.duration}åˆ†é–“æœ‰åŠ¹</div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else if (app.currentTab === 'community') {
            tabContent.innerHTML = `
                <div class="card">
                    <div class="card-title">ãƒ­ãƒ¼ã‚«ãƒ«æŠ•ç¨¿</div>
                    <div class="post-feed">
                        ${app.posts.map(post => `
                            <div class="post-card">
                                <div class="post-header">
                                    <div class="post-category">${post.category}</div>
                                    <div class="post-time">${formatTimeAgo(post.timestamp)}</div>
                                </div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">${post.author}</div>
                                <div class="post-content">${post.content}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    }

    // éŸ³å£°å…¥åŠ›å‡¦ç†
    function handleVoiceInput() {
        const voiceInput = document.getElementById('voiceInput');
        voiceInput.classList.add('active');
        voiceInput.innerHTML = `
            <div style="font-size: 2rem; margin-bottom: 0.5rem;" class="pulse">ğŸ¤</div>
            <div style="font-weight: 600;">èã„ã¦ã„ã¾ã™...</div>
        `;

        setTimeout(() => {
            const mockInput = "ä»Šã‹ã‚‰ãƒ­ãƒ¼ã‚½ãƒ³ã§ã‚³ãƒ¼ãƒ’ãƒ¼1ã¤è²·ã£ã¦ãã¦æ¬²ã—ã„ã€300å††æ‰•ã„ã¾ã™";
            app.voiceInput = mockInput;
            
            voiceInput.innerHTML = `
                <div>"${mockInput}"</div>
                <div style="margin-top: 0.5rem; color: #3b82f6; font-weight: 600;">âš¡ AIè§£æä¸­...</div>
            `;

            setTimeout(() => {
                document.getElementById('taskTitle').value = 'ã‚³ãƒ¼ãƒ’ãƒ¼ã®è³¼å…¥ä»£è¡Œ';
                document.getElementById('taskLocation').value = 'ãƒ­ãƒ¼ã‚½ãƒ³ æ¸‹è°·3ä¸ç›®åº—';
                document.getElementById('taskDetails').value = 'ã‚³ãƒ¼ãƒ’ãƒ¼1ã¤è³¼å…¥ã‚’ãŠé¡˜ã„ã—ã¾ã™';
                document.getElementById('taskReward').value = '300';
                
                voiceInput.classList.remove('active');
                voiceInput.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">âœ…</div>
                    <div style="font-weight: 600;">è§£æå®Œäº†ï¼</div>
                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                        ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã—ãŸ
                    </div>
                `;
            }, 1500);
        }, 2000);
    }

    // ã‚¿ã‚¹ã‚¯ä½œæˆ
    function createTask() {
        const title = document.getElementById('taskTitle').value;
        const location = document.getElementById('taskLocation').value;
        const details = document.getElementById('taskDetails').value;
        const reward = parseInt(document.getElementById('taskReward').value);

        if (!title || !location || !reward) {
            alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        app.selectedTask = {
            title,
            location,
            details,
            reward,
            duration: 15
        };

        app.currentStep = 'matching';
        render();
        updateMapMarkers();
    }

    // ã‚¿ã‚¹ã‚¯é¸æŠ
    function selectTask(taskId) {
        app.selectedTask = app.tasks.find(t => t.id === taskId);
        app.currentStep = 'matching';
        render();
    }

    // ãƒãƒƒãƒãƒ³ã‚°ç”»é¢
    function renderMatching() {
        const content = document.getElementById('mainContent');
        content.innerHTML = `
            <div class="card">
                <h3 style="font-weight: bold;">ğŸ’¼ ${app.selectedTask.title}</h3>
                <p style="color: #6b7280;">${app.selectedTask.location}</p>
                <p style="font-size: 0.875rem; margin-top: 0.5rem;">
                    ğŸ’µ ${app.selectedTask.reward} JPYC | â±ï¸ ${app.selectedTask.duration}åˆ†é–“æœ‰åŠ¹
                </p>
            </div>

            <div class="card">
                <div class="card-title">è¿‘ãã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ (500mä»¥å†…)</div>
                ${app.helpers.map(helper => `
                    <div class="user-card" onclick="selectHelper(${helper.id})">
                        <div class="user-avatar">ğŸ‘¤</div>
                        <div class="user-info">
                            <div class="user-name">${helper.name}</div>
                            <div class="user-meta">
                                â­ ${helper.rating} | ğŸ“ ${helper.distance}m | â±ï¸ ${helper.response}
                            </div>
                        </div>
                        <div class="user-select">é¸æŠ</div>
                    </div>
                `).join('')}
            </div>

            <button class="btn btn-secondary" onclick="backToHome()">æˆ»ã‚‹</button>
        `;
    }

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é¸æŠ
    function selectHelper(helperId) {
        app.selectedHelper = app.helpers.find(h => h.id === helperId);
        app.currentStep = 'payment';
        render();
    }

    // æ”¯æ‰•ã„ç”»é¢
    function renderPayment() {
        const content = document.getElementById('mainContent');
        const fee = Math.round(app.selectedTask.reward * 0.1);
        const total = app.selectedTask.reward + fee;

        content.innerHTML = `
            <div class="card">
                <div class="center">
                    <div class="icon-circle" style="background: linear-gradient(135deg, #10b981, #3b82f6); width: 4rem; height: 4rem; font-size: 1.5rem;">âœ“</div>
                    <h2>ãƒãƒƒãƒãƒ³ã‚°æˆç«‹!</h2>
                    <p style="color: #6b7280;">${app.selectedHelper.name}ã•ã‚“ãŒå¯¾å¿œã—ã¾ã™</p>
                </div>

                <div class="summary">
                    <div class="summary-row">
                        <span>ä¾é ¼å†…å®¹</span>
                        <span>${app.selectedTask.title}</span>
                    </div>
                    <div class="summary-row">
                        <span>å ±é…¬</span>
                        <span>${app.selectedTask.reward} JPYC</span>
                    </div>
                    <div class="summary-row">
                        <span>æ‰‹æ•°æ–™</span>
                        <span>${fee} JPYC (10%)</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>åˆè¨ˆ</span>
                        <span style="color: #a855f7; font-size: 1.125rem;">${total} JPYC</span>
                    </div>
                </div>

                <button class="btn btn-green" onclick="completePayment()">
                    ğŸ’³ JPYC ã§æ”¯æ‰•ã†
                </button>
                <p style="text-align: center; margin-top: 0.75rem; font-size: 0.875rem; color: #6b7280;">
                    ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã§ã‚¨ã‚¹ã‚¯ãƒ­ãƒ¼ä¿è­·
                </p>
            </div>
        `;
    }

    // æ”¯æ‰•ã„å®Œäº†
    function completePayment() {
        app.currentStep = 'complete';
        render();
    }

    // å®Œäº†ç”»é¢
    function renderComplete() {
        const content = document.getElementById('mainContent');
        content.innerHTML = `
            <div class="card">
                <div class="center">
                    <div class="icon-circle bounce" style="background: linear-gradient(135deg, #10b981, #3b82f6);">âœ“</div>
                    <h2 style="font-size: 1.5rem;">å–å¼•å®Œäº†!</h2>
                    <p style="color: #6b7280;">${app.selectedHelper.name}ã•ã‚“ã¸ã®æ”¯æ‰•ã„ãŒå®Œäº†ã—ã¾ã—ãŸ</p>
                </div>

                <div class="tech-stack">
                    <div class="tech-stack-title">âœ¨ å®Ÿè£…æ¸ˆã¿ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯</div>
                    <ul>
                        <li>OpenAI Structured Outputs (éŸ³å£°â†’JSON)</li>
                        <li>MapLibre GL JS (é«˜æ€§èƒ½åœ°å›³)</li>
                        <li>PostGISç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (500måœå†…æ¤œç´¢)</li>
                        <li>JPYC Ã— Polygon (ã‚¨ã‚¹ã‚¯ãƒ­ãƒ¼è‡ªå‹•æ±ºæ¸ˆ)</li>
                        <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥</li>
                        <li>ä½ç½®æƒ…å ±ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒãƒ³ã‚°</li>
                    </ul>
                </div>

                <button class="btn" onclick="backToHome()">
                    æ–°ã—ã„ä¾é ¼ã‚’ä½œæˆ
                </button>
            </div>
        `;
    }

    // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
    function backToHome() {
        app.currentStep = 'home';
        app.selectedTask = null;
        app.selectedHelper = null;
        app.voiceInput = '';
        render();
    }

    // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatTimeAgo(timestamp) {
        const diff = Date.now() - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        
        if (minutes < 1) return 'ãŸã£ãŸä»Š';
        if (minutes < 60) return `${minutes}åˆ†å‰`;
        return `${hours}æ™‚é–“å‰`;
    }

    // åœ°å›³ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('showTasks').addEventListener('click', function() {
        app.mapMode = 'tasks';
        document.querySelectorAll('.map-control-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        updateMapMarkers();
    });

    document.getElementById('showHelpers').addEventListener('click', function() {
        app.mapMode = 'helpers';
        document.querySelectorAll('.map-control-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        updateMapMarkers();
    });

    document.getElementById('showPosts').addEventListener('click', function() {
        app.mapMode = 'posts';
        document.querySelectorAll('.map-control-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        updateMapMarkers();
    });

    // ä½ç½®æƒ…å ±å–å¾—
    function getLocation() {
        if (!navigator.geolocation) {
            alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                app.currentLocation = { lat, lng };
                document.getElementById('headerLocation').textContent = `ğŸ“ ç·¯åº¦: ${lat.toFixed(4)}, çµŒåº¦: ${lng.toFixed(4)}`;
                
                initMap(lat, lng);
                generateSampleData();
                render();
            },
            (error) => {
                console.error('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ¸‹è°·ï¼‰
                const defaultLat = 35.6595;
                const defaultLng = 139.7004;
                app.currentLocation = { lat: defaultLat, lng: defaultLng };
                document.getElementById('headerLocation').textContent = 'ğŸ“ æ¸‹è°·é§…å‘¨è¾º';
                
                initMap(defaultLat, defaultLng);
                generateSampleData();
                render();
            }
        );
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
        getLocation();
    });
</script>